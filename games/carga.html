<!DOCTYPE html>
<html>
<head>
    <title>Carga y Desafío - Ley de Coulomb</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        #gameContainer {
            margin: 0 auto;
            width: 600px;
        }
        canvas {
            background: #fff;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .controls {
            margin: 15px 0;
            padding: 10px;
            background: #eee;
            border-radius: 8px;
        }
        .level-info {
            margin: 10px 0;
            font-weight: bold;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1>⚡ Carga y Desafío</h1>
        <div class="level-info" id="levelInfo">Nivel 1: Mueve la carga azul para empujar la roja a la meta.</div>
        <div class="controls">
            <label>Carga Jugador (q1): <input type="range" id="q1Slider" min="-100" max="100" value="50"></label>
            <span id="q1Value">50</span><br>
            <label>Carga Objetivo (q2): <input type="range" id="q2Slider" min="-100" max="100" value="-50" disabled></label>
            <span id="q2Value">-50</span><br>
            <button id="resetBtn">Reiniciar Nivel</button>
            <button id="nextBtn">Siguiente Nivel</button>
        </div>
        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <script>
        // Configuración inicial
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const q1Slider = document.getElementById('q1Slider');
        const q2Slider = document.getElementById('q2Slider');
        const q1Value = document.getElementById('q1Value');
        const q2Value = document.getElementById('q2Value');
        const resetBtn = document.getElementById('resetBtn');
        const nextBtn = document.getElementById('nextBtn');
        const levelInfo = document.getElementById('levelInfo');

        // Constante de Coulomb (ajustada para visualización)
        const k = 5000;
        let currentLevel = 1;
        let gameComplete = false;

        // Objetos del juego
        const player = { 
            x: 100, 
            y: 200, 
            q: 50, 
            radius: 20, 
            color: '#3498db',
            isDragging: false
        };

        const target = { 
            x: 450, 
            y: 200, 
            q: -50, 
            radius: 15, 
            color: '#e74c3c',
            originalX: 450,
            originalY: 200
        };

        const goal = { 
            x: 500, 
            y: 200, 
            width: 40, 
            height: 40, 
            color: '#2ecc71'
        };

        const obstacles = [
            { x: 300, y: 150, width: 20, height: 200, color: '#95a5a6' }
        ];

        // Actualizar valores de los sliders
        q1Slider.addEventListener('input', function() {
            player.q = parseInt(this.value);
            q1Value.textContent = player.q;
        });

        q2Slider.addEventListener('input', function() {
            target.q = parseInt(this.value);
            q2Value.textContent = target.q;
        });

        // Reiniciar nivel
        resetBtn.addEventListener('click', resetLevel);

        // Siguiente nivel
        nextBtn.addEventListener('click', nextLevel);

        // Interacción con ratón
        canvas.addEventListener('mousedown', handleMouseDown);
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('mouseup', handleMouseUp);

        function handleMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // Verificar si se está arrastrando la carga del jugador
            const distance = Math.sqrt((mouseX - player.x) ** 2 + (mouseY - player.y) ** 2);
            if (distance <= player.radius) {
                player.isDragging = true;
            }
        }

        function handleMouseMove(e) {
            if (player.isDragging) {
                const rect = canvas.getBoundingClientRect();
                player.x = e.clientX - rect.left;
                player.y = e.clientY - rect.top;

                // Limitar al área del canvas
                player.x = Math.max(player.radius, Math.min(canvas.width - player.radius, player.x));
                player.y = Math.max(player.radius, Math.min(canvas.height - player.radius, player.y));
            }
        }

        function handleMouseUp() {
            player.isDragging = false;
        }

        // Calcular fuerza de Coulomb
        function calculateForce(q1, q2, r) {
            if (r === 0) return { fx: 0, fy: 0 }; // Evitar división por cero
            const forceMagnitude = k * Math.abs(q1 * q2) / (r ** 2);
            return forceMagnitude;
        }

        // Actualizar física del juego
        function updatePhysics() {
            // Calcular distancia entre jugador y objetivo
            const dx = target.x - player.x;
            const dy = target.y - player.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // Calcular fuerza
            const force = calculateForce(player.q, target.q, distance);

            // Calcular componentes de la fuerza (dirección)
            if (distance > 0) {
                const fx = force * dx / distance;
                const fy = force * dy / distance;

                // Aplicar fuerza al objetivo (inversa porque la fuerza es sobre el objetivo)
                // Solo si no está en la meta
                if (!checkGoalCollision()) {
                    target.x -= fx * 0.05;
                    target.y -= fy * 0.05;
                }
            }

            // Verificar colisión con obstáculos
            checkObstacleCollision();
        }

        // Verificar si el objetivo está en la meta
        function checkGoalCollision() {
            const goalCenterX = goal.x + goal.width / 2;
            const goalCenterY = goal.y + goal.height / 2;
            const distance = Math.sqrt(
                (target.x - goalCenterX) ** 2 + 
                (target.y - goalCenterY) ** 2
            );

            return distance < (target.radius + Math.min(goal.width, goal.height) / 2);
        }

        // Verificar colisión con obstáculos
        function checkObstacleCollision() {
            obstacles.forEach(obstacle => {
                // Lógica simple de colisión rectangular
                if (target.x + target.radius > obstacle.x && 
                    target.x - target.radius < obstacle.x + obstacle.width &&
                    target.y + target.radius > obstacle.y && 
                    target.y - target.radius < obstacle.y + obstacle.height) {
                    // Si choca, volver a la posición original
                    target.x = target.originalX;
                    target.y = target.originalY;
                }
            });
        }

        // Dibujar el juego
        function draw() {
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar meta
            ctx.fillStyle = goal.color;
            ctx.fillRect(goal.x, goal.y, goal.width, goal.height);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.font = '14px Arial';
            ctx.fillText('META', goal.x + 5, goal.y + 25);

            // Dibujar obstáculos
            obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.color;
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            });

            // Dibujar carga objetivo
            ctx.fillStyle = target.color;
            ctx.beginPath();
            ctx.arc(target.x, target.y, target.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(target.q > 0 ? '+' + target.q : target.q, target.x, target.y + 4);

            // Dibujar carga jugador
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.fillText(player.q > 0 ? '+' + player.q : player.q, player.x, player.y + 4);

            // Dibujar línea de fuerza (si no están muy cerca)
            const dx = target.x - player.x;
            const dy = target.y - player.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance > player.radius + target.radius + 10) {
                ctx.strokeStyle = player.q * target.q < 0 ? '#9b59b6' : '#f39c12'; // Atracción: morado, Repulsión: naranja
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(target.x, target.y);
                ctx.stroke();

                // Flecha de dirección
                const angle = Math.atan2(dy, dx);
                drawArrowhead(target.x, target.y, angle, player.q * target.q < 0 ? '#9b59b6' : '#f39c12');
            }

            // Mostrar mensaje de nivel completado
            if (checkGoalCollision() && !gameComplete) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '30px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('¡Nivel Completado!', canvas.width / 2, canvas.height / 2);
                ctx.font = '20px Arial';
                ctx.fillText('Presiona "Siguiente Nivel"', canvas.width / 2, canvas.height / 2 + 40);
            }
        }

        // Dibujar punta de flecha
        function drawArrowhead(x, y, angle, color) {
            ctx.fillStyle = color;
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-15, -8);
            ctx.lineTo(-15, 8);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        // Bucle del juego
        function gameLoop() {
            updatePhysics();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Reiniciar nivel
        function resetLevel() {
            player.x = 100;
            player.y = 200;
            player.q = 50;
            q1Slider.value = 50;
            q1Value.textContent = '50';

            target.x = target.originalX;
            target.y = target.originalY;
            target.q = -50;
            q2Slider.value = -50;
            q2Value.textContent = '-50';

            gameComplete = false;
        }

        // Siguiente nivel
        function nextLevel() {
            if (!checkGoalCollision()) return;

            currentLevel++;
            gameComplete = true;

            switch (currentLevel) {
                case 2:
                    levelInfo.textContent = 'Nivel 2: Atrae la carga negativa a la meta sin tocar el obstáculo.';
                    target.q = -30;
                    q2Slider.disabled = false;
                    q2Slider.value = -30;
                    q2Value.textContent = '-30';
                    resetLevel();
                    break;
                case 3:
                    levelInfo.textContent = 'Nivel 3: Usa repulsión para llevar la carga positiva a la meta.';
                    target.q = 50;
                    q2Slider.value = 50;
                    q2Value.textContent = '50';
                    resetLevel();
                    break;
                default:
                    levelInfo.textContent = '¡Todos los niveles completados!';
                    nextBtn.disabled = true;
                    break;
            }
        }

        // Iniciar juego
        resetLevel();
        gameLoop();
    </script>
</body>
</html>