<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Circuitos</title>
    <link rel="stylesheet" href="../style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos generales */
        :root {
            --color-primary: #3498db;
            --color-secondary: #e74c3c;
            --color-success: #2ecc71;
            --color-error: #e74c3c;
            --color-warning: #f39c12;
            --color-text: #2c3e50;
            --color-light: #ecf0f1;
            --color-dark: #34495e;
            --color-gray: #95a5a6;
            --color-bg: #f5f7fa;
            --color-circuit-bg: #f8f9fa;
            --color-wire: #7f8c8d;
            --color-battery: #f1c40f;
            --color-resistor: #e67e22;
            --color-bulb-off: #45a4e4;
            --color-bulb-on: #f1c40f;
            --color-switch: #9b59b6;
            --color-led-off: #2bd21c;
            --color-led-on: #2ecc71;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--color-text);
            background-color: var(--color-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
            
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Contenido principal */
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
            flex: 1;
            position: relative;
        }
        
        /* Estilos para el bloqueo en móviles */
        .mobile-block {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        
        .block-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .block-icon {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--color-error);
        }
        
        .block-content h3 {
            color: var(--color-dark);
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .block-content p {
            color: var(--color-text);
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 16px;
        }
        
        .btn-close {
            background: linear-gradient(135deg, var(--color-primary), #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Estilos del juego */
        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 8px 16px;
            background-color: #f0f0f0;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .back-btn:hover {
            background-color: #e0e0e0;
        }
        
        .game-container {
            width: 100%;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 3px 24px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 25px;
        }
        
        .game-container h1 {
            color: var(--color-dark);
            font-size: 28px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .level-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .level-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background-color: var(--color-light);
            color: var(--color-dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .level-btn.active {
            background-color: var(--color-primary);
            color: white;
        }
        
        .level-btn:hover:not(.active) {
            background-color: #d6eaf8;
        }
        
        .game-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 15px;
        }
        
        .stat {
            font-weight: 600;
            color: var(--color-dark);
        }
        
        .instructions {
            color: var(--color-text);
            font-size: 16px;
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--color-light);
            border-radius: 8px;
        }
        
        /* Área de juego de circuitos */
        .circuit-game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .circuit-board {
            width: 100%;
            min-height: 300px;
            background-color: var(--color-circuit-bg);
            border-radius: 10px;
            border: 2px dashed var(--color-gray);
            position: relative;
            overflow: hidden;
            padding: 20px;
        }
        
        .circuit-components {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: var(--color-light);
            border-radius: 10px;
        }
        
        .component {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: grab;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
            position: relative;
        }
        
        .component i {
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .component:active {
            cursor: grabbing;
        }
        
        .component:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        
        .component.dragging {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        .component.battery {
            background: linear-gradient(135deg, var(--color-battery), #e67e22);
        }
        
        .component.resistor {
            background: linear-gradient(135deg, var(--color-resistor), #d35400);
        }
        
        .component.bulb {
            background: linear-gradient(135deg, var(--color-bulb-off), #1598a1);
        }
        
        .component.bulb.on {
            background: linear-gradient(135deg, var(--color-bulb-on), #f39c12);
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.7);
        }
        
        .component.switch {
            background: linear-gradient(135deg, var(--color-switch), #8e44ad);
        }
        
        .component.switch.on {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .component.wire {
            background: linear-gradient(135deg, var(--color-wire), #34495e);
        }
        
        .component.led {
            background: linear-gradient(135deg, var(--color-led-off), #1e823a);
        }
        
        .component.led.on {
            background: linear-gradient(135deg, var(--color-led-on), #27ae60);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.7);
        }
        
        /* Componentes colocados en el circuito */
        .placed-component {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            z-index: 10;
        }
        
        .placed-component i {
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .placed-component .component-label {
            font-size: 12px;
            font-weight: bold;
            color: var(--color-dark);
            background-color: white;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 5px;
        }
        
        .placed-component.bulb.on {
            animation: bulbGlow 0.5s infinite alternate;
        }

        .placed-component.bulb.on i {
            color: #ffeb3b;
            text-shadow: 0 0 10px #ffeb3b, 
                        0 0 20px #ffeb3b, 
                        0 0 30px #ffeb3b;
        }

        .placed-component.led.on i {
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00, 
                        0 0 10px #00ff00;
        }

        @keyframes bulbGlow {
            from {
                filter: drop-shadow(0 0 5px rgba(255, 235, 59, 0.7));
            }
            to {
                filter: drop-shadow(0 0 20px rgba(255, 235, 59, 0.9));
            }
        }

        .connection-point {
            width: 12px;
            height: 12px;
            background-color: var(--color-primary);
            border-radius: 50%;
            position: absolute;
            z-index: 20;
            cursor: pointer;
            border: 2px solid white;
        }
        
        .connection-point:hover {
            transform: scale(1.3);
        }
        
        .wire-connection {
            position: absolute;
            background-color: var(--color-wire);
            height: 4px;
            transform-origin: left center;
            z-index: 5;
        }
        
        .circuit-info {
            display: none;
            justify-content: space-around;
            background-color: var(--color-light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .circuit-value {
            text-align: center;
        }
        
        .circuit-value h3 {
            font-size: 14px;
            color: var(--color-gray);
            margin-bottom: 5px;
        }
        
        .circuit-value p {
            font-weight: bold;
            font-size: 18px;
            color: var(--color-dark);
        }
        
        .energy-bar {
            width: 100%;
            height: 10px;
            background-color: var(--color-light);
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .energy-level {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success), var(--color-warning));
            width: 100%;
            transition: width 0.5s;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-check {
            background: linear-gradient(135deg, var(--color-success), #27ae60);
            color: white;
        }
        
        .btn-reset {
            background: white;
            color: var(--color-dark);
            border: 2px solid var(--color-dark);
        }

        .btn-delete {
            background: linear-gradient(135deg, var(--color-error), #c0392b);
            color: white;
        }
        
        .game-feedback {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            font-weight: 600;
            border-radius: 8px;
            display: none;
            animation: fadeIn 0.4s ease-out;
        }
        
        .feedback-success {
            background-color: rgba(46, 204, 113, 0.15);
            color: var(--color-success);
            display: block;
        }
        
        .feedback-error {
            background-color: rgba(231, 76, 60, 0.15);
            color: var(--color-error);
            display: block;
        }
        
        .feedback-warning {
            background-color: rgba(243, 156, 18, 0.15);
            color: var(--color-warning);
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Footer */
        footer {
            background: linear-gradient(135deg, var(--color-dark), #2c3e50);
            color: white;
            text-align: center;
            padding: 1.5rem;
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Media queries responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .hamburger-btn {
                display: block;
                position: absolute;
                top: 1rem;
                right: 1rem;
            }
            
            nav {
                width: 100%;
                display: none;
            }
            
            nav.active {
                display: block;
            }
            
            nav ul {
                flex-direction: column;
                width: 100%;
            }
            
            nav ul li {
                margin: 0.5rem 0;
            }
            
            .container {
                padding: 10px;
            }
            
            .game-container {
                padding: 15px;
            }
            
            .game-container h1 {
                font-size: 24px;
            }
            
            .level-selector {
                flex-wrap: wrap;
            }
            
            .level-btn {
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .game-stats {
                flex-direction: column;
                gap: 5px;
            }
            
            .stat {
                font-size: 14px;
            }
            
            .instructions {
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            .circuit-board {
                min-height: 250px;
                padding: 15px;
            }
            
            .circuit-components {
                padding: 15px;
                gap: 10px;
            }
            
            .component {
                width: 70px;
                height: 70px;
                font-size: 12px;
            }
            
            .component i {
                font-size: 25px;
            }
            
            .circuit-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .game-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="../home.html" class="logo">
                <i class="fas fa-atom"></i>
                <span>Física Interactiva</span>
            </a>
            <button class="hamburger-btn" aria-label="Menú">
                <i class="fas fa-bars"></i>
            </button>
            <nav>
                <ul>
                    <li><a href="../home.html"><i class="fas fa-home"></i> Inicio</a></li>
                    <li><a href="../templates/games.html"><i class="fas fa-gamepad"></i> Mini Juegos</a></li>
                    <li><a href="../templates/calculator.html"><i class="fas fa-calculator"></i> Calculadora</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="mobile-block">
        <div class="block-content">
            <div class="block-icon">
                <i class="fas fa-ban"></i>
            </div>
            <h3>Juego no disponible en dispositivos móviles</h3>
            <p>Este juego está diseñado exclusivamente para ser utilizado en computadoras. Por favor, accede desde un ordenador para disfrutar de la experiencia completa.</p>
            <button class="btn-close" onclick="window.location.href='../templates/games.html'">Volver a juegos</button>
        </div>
    </div>

    <div class="container">
        <a href="../templates/games.html" class="back-btn"><i class="fas fa-arrow-left"></i> Volver a juegos</a>
        
        <div class="game-container">
            <h1><i class="fas fa-bolt"></i> Enciende el Laboratorio</h1>
            
            <div class="level-selector">
                <button class="level-btn active" data-level="1">Nivel 1</button>
                <button class="level-btn" data-level="2">Nivel 2</button>
                <button class="level-btn" data-level="3">Nivel 3</button>
                <button class="level-btn" data-level="4">Nivel 4</button>
            </div>
            
            <div class="game-stats">
                <div class="stat">Energía: <span id="energy">100</span>%</div>
                <div class="stat">Intentos: <span id="attempts">0</span></div>
                <div class="stat">Puntuación: <span id="score">0</span></div>
            </div>
            
            <div class="instructions" id="instructions">
                Arrastra componentes al área de trabajo y conéctalos para completar el circuito. El foco debe encenderse cuando el circuito esté correctamente armado.
            </div>
            
            <div class="circuit-board" id="circuit-board">
                <!-- Aquí se colocan los componentes del circuito -->
            </div>
            
            <div class="circuit-info">
                <div class="circuit-value">
                    <h3>Voltaje (V)</h3>
                    <p id="voltage">0 V</p>
                </div>
                <div class="circuit-value">
                    <h3>Corriente (I)</h3>
                    <p id="current">0 A</p>
                </div>
                <div class="circuit-value">
                    <h3>Resistencia (R)</h3>
                    <p id="resistance">0 Ω</p>
                </div>
            </div>
            
            <div class="energy-bar">
                <div class="energy-level" id="energy-level"></div>
            </div>
            
            <div class="circuit-components">
                <div class="component battery" draggable="true" data-type="battery" data-voltage="9">
                    <i class="fas fa-battery-full"></i>
                    <span>Batería 9V</span>
                </div>
                <div class="component resistor" draggable="true" data-type="resistor" data-resistance="100">
                    <i class="fas fa-wave-square"></i>
                    <span>Resistencia 100Ω</span>
                </div>
                <div class="component bulb" draggable="true" data-type="bulb" data-resistance="50">
                    <i class="fas fa-lightbulb"></i>
                    <span>Foco</span>
                </div>
                <div class="component switch" draggable="true" data-type="switch">
                    <i class="fas fa-toggle-off"></i>
                    <span>Interruptor</span>
                </div>
                <div class="component wire" draggable="true" data-type="wire">
                    <i class="fas fa-link"></i>
                    <span>Cable</span>
                </div>
                <div class="component led" draggable="true" data-type="led" data-resistance="20">
                    <i class="fas fa-circle"></i>
                    <span>LED</span>
                </div>
            </div>
            
            <div class="game-controls">
                <button class="btn btn-check" id="check-circuit"><i class="fas fa-bolt"></i> Encender</button>
                <button class="btn btn-reset" id="reset-circuit"><i class="fas fa-redo"></i> Reiniciar</button>
                <button class="btn btn-delete" id="clear-all"><i class="fas fa-trash"></i> Borrar Todo</button>
            </div>
            
            <div class="game-feedback" id="game-feedback"></div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>© 2025 Jorge Alberto · Física Interactiva · Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        // Función para detectar si es un dispositivo móvil
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || 
                   (navigator.userAgent.indexOf('IEMobile') !== -1) ||
                   (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
        }
        
        // Mostrar bloqueo si es móvil
        if (isMobileDevice()) {
            document.querySelector('.mobile-block').style.display = 'flex';
            // Ocultar el contenido del juego
            document.querySelector('.container').style.display = 'none';
            document.querySelector('footer').style.display = 'none';
        } else {
            // Iniciar el juego solo si no es móvil
            document.addEventListener('DOMContentLoaded', function() {
                // Variables del juego
                let currentLevel = 1;
                let energy = 100;
                let attempts = 0;
                let placedComponents = [];
                let connections = [];
                let isConnecting = false;
                let draggedComponent = null;
                
                // Niveles del juego
                const levels = {
                    1: {
                        title: "Circuito básico",
                        instructions: "Arrastra una batería, un foco y una resistencia al área de trabajo. Conéctalos para completar el circuito y encender el foco.",
                        requiredComponents: ["battery", "bulb", "resistor"],
                        requiredConnections: 2,
                        voltage: 9,
                        resistance: 150,
                        points: 10
                    },
                    2: {
                        title: "Circuito con interruptor",
                        instructions: "Arma un circuito con batería, foco y un interruptor. El foco solo debe encenderse cuando el interruptor esté activado.",
                        requiredComponents: ["battery", "bulb", "switch"],
                        requiredConnections: 3,
                        voltage: 9,
                        resistance: 50,
                        points: 20
                    },
                    3: {
                        title: "Circuito en paralelo",
                        instructions: "Crea un circuito en paralelo con 2 focos y 4 cables. Ambos deben encenderse cuando el circuito esté completo.",
                        requiredComponents: ["battery", "bulb", "bulb", "wire", "wire", "wire", "wire"],
                        requiredConnections: 4,
                        voltage: 9,
                        resistance: {
                            type: "parallel",
                            values: [50, 50], // Resistencia de cada foco
                            expected: 25       // Valor esperado (1/(1/50 + 1/50))
                        },
                        points: 30
                    },
                    4: {
                        title: "Circuito con LED",
                        instructions: "Protege un LED con una resistencia adecuada (entre 100Ω y 150Ω). El LED solo debe encenderse con la resistencia correcta y la polaridad adecuada.",
                        requiredComponents: ["battery", "led", "resistor"],
                        requiredConnections: 2,
                        voltage: 9,
                        resistance: {
                            min: 100,
                            max: 150
                        },
                        points: 40,
                        ledPolarity: true // Indica que la polaridad es importante para este nivel
                    }
                };
                
                // Elementos del DOM
                const circuitBoard = document.getElementById('circuit-board');
                const energyDisplay = document.getElementById('energy');
                const energyLevel = document.getElementById('energy-level');
                const attemptsDisplay = document.getElementById('attempts');
                const instructionsDisplay = document.getElementById('instructions');
                const voltageDisplay = document.getElementById('voltage');
                const currentDisplay = document.getElementById('current');
                const resistanceDisplay = document.getElementById('resistance');
                const feedbackDisplay = document.getElementById('game-feedback');
                const checkButton = document.getElementById('check-circuit');
                const resetButton = document.getElementById('reset-circuit');
                const clearAllButton = document.getElementById('clear-all');
                const levelButtons = document.querySelectorAll('.level-btn');
                const scoreDisplay = document.getElementById('score');
                
                // Variables de puntuación
                let score = 0;
                
                // Sonidos
                const soundPowerOn = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3');
                const soundPowerOff = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.mp3');
                const soundSuccess = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3');
                const soundError = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-changing-tab-206.mp3');
                const soundLevelUp = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3');
                
                // Event listeners para los botones de nivel
                levelButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        changeLevel(parseInt(this.dataset.level));
                    });
                });
                
                // Función para cambiar de nivel
                function changeLevel(level) {
                    currentLevel = level;
                    
                    // Actualizar botones de nivel
                    levelButtons.forEach(btn => {
                        btn.classList.toggle('active', parseInt(btn.dataset.level) === currentLevel);
                    });
                    
                    loadLevel(currentLevel);
                }
                
                // Cargar nivel
                function loadLevel(level) {
                    resetCircuit();
                    const levelData = levels[level];
                    document.querySelector('.game-container h1').innerHTML = `<i class="fas fa-bolt"></i> ${levelData.title}`;
                    instructionsDisplay.textContent = levelData.instructions;
                    
                    // Actualizar valores esperados
                    if (level === 4) {
                        voltageDisplay.textContent = `${levelData.voltage} V`;
                        resistanceDisplay.textContent = `100-150 Ω`;
                        currentDisplay.textContent = `${(levelData.voltage / 120).toFixed(2)} A`; // Valor medio para mostrar
                    } else if (typeof levelData.resistance === 'object' && levelData.resistance.type === "parallel") {
                        voltageDisplay.textContent = `${levelData.voltage} V`;
                        resistanceDisplay.textContent = `${levelData.resistance.expected} Ω`;
                        currentDisplay.textContent = `${(levelData.voltage / levelData.resistance.expected).toFixed(2)} A`;
                    } else if (typeof levelData.resistance === 'object') {
                        voltageDisplay.textContent = `${levelData.voltage} V`;
                        resistanceDisplay.textContent = `${levelData.resistance.min}-${levelData.resistance.max} Ω`;
                        currentDisplay.textContent = `${(levelData.voltage / ((levelData.resistance.min + levelData.resistance.max)/2)).toFixed(2)} A`;
                    } else {
                        voltageDisplay.textContent = `${levelData.voltage} V`;
                        resistanceDisplay.textContent = `${levelData.resistance} Ω`;
                        currentDisplay.textContent = `${(levelData.voltage / levelData.resistance).toFixed(2)} A`;
                    }
                }
                
                // Reiniciar circuito
                function resetCircuit() {
                    circuitBoard.innerHTML = '';
                    placedComponents = [];
                    connections = [];
                    feedbackDisplay.style.display = 'none';
                    updateEnergy(0);
                    
                    // Apagar todos los componentes
                    document.querySelectorAll('.placed-component.bulb, .placed-component.led').forEach(comp => {
                        comp.classList.remove('on');
                        const icon = comp.querySelector('i');
                        icon.style.textShadow = 'none';
                        icon.style.color = '';
                    });
                    
                    soundPowerOff.play();
                }
                
                // Actualizar energía
                function updateEnergy(change) {
                    energy += change;
                    if (energy > 100) energy = 100;
                    if (energy < 0) energy = 0;
                    
                    energyDisplay.textContent = energy;
                    energyLevel.style.width = `${energy}%`;
                    
                    // Cambiar color según la energía
                    if (energy > 60) {
                        energyLevel.style.background = 'linear-gradient(90deg, var(--color-success), var(--color-warning))';
                    } else if (energy > 30) {
                        energyLevel.style.background = 'linear-gradient(90deg, var(--color-warning), var(--color-error))';
                    } else {
                        energyLevel.style.background = 'var(--color-error)';
                    }
                    
                    if (energy <= 0) {
                        showFeedback("¡Se acabó la energía! Reinicia el juego.", "error");
                        setTimeout(resetCircuit, 2000);
                    }
                }
                
                // Mostrar feedback
                function showFeedback(message, type) {
                    feedbackDisplay.textContent = message;
                    feedbackDisplay.className = 'game-feedback';
                    feedbackDisplay.classList.add(`feedback-${type}`);
                    feedbackDisplay.style.display = 'block';
                    
                    // Reproducir sonido
                    if (type === 'success') {
                        soundSuccess.play();
                    } else {
                        soundError.play();
                    }
                    
                    setTimeout(() => {
                        feedbackDisplay.style.display = 'none';
                    }, 3000);
                }
                
                // Crear componente en el área de trabajo
                function createPlacedComponent(type, x, y, data) {
                    const component = document.createElement('div');
                    component.className = `placed-component ${type}`;
                    component.style.left = `${x}px`;
                    component.style.top = `${y}px`;
                    component.dataset.type = type;
                    
                    // Configurar según el tipo de componente
                    let iconClass, label;
                    switch(type) {
                        case 'battery':
                            iconClass = 'fas fa-battery-full';
                            label = `${data.voltage}V`;
                            component.dataset.voltage = data.voltage;
                            break;
                        case 'resistor':
                            iconClass = 'fas fa-wave-square';
                            label = `${data.resistance}Ω`;
                            component.dataset.resistance = data.resistance;
                            break;
                        case 'bulb':
                            iconClass = 'fas fa-lightbulb bulb-icon';
                            label = 'Foco';
                            component.dataset.resistance = data.resistance;
                            break;
                        case 'switch':
                            iconClass = 'fas fa-toggle-off';
                            label = 'Interruptor';
                            component.dataset.state = 'off';
                            break;
                        case 'wire':
                            iconClass = 'fas fa-link';
                            label = 'Cable';
                            break;
                        case 'led':
                            iconClass = 'fas fa-circle led-icon';
                            label = 'LED';
                            component.dataset.resistance = data.resistance;
                            component.dataset.polarity = 'correct'; // Por defecto asumimos polaridad correcta
                            break;
                    }
                    
                    component.innerHTML = `
                        <i class="${iconClass}"></i>
                        <span class="component-label">${label}</span>
                    `;
                    
                    // Añadir puntos de conexión
                    addConnectionPoints(component);
                    
                    // Hacer el componente arrastrable
                    makeDraggable(component);
                    
                    // Añadir evento para eliminar con clic derecho
                    component.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        if (confirm("¿Eliminar este componente?")) {
                            // Eliminar conexiones asociadas
                            connections = connections.filter(conn => 
                                conn.start.parentElement !== component && 
                                conn.end.parentElement !== component
                            );
                            // Eliminar el componente
                            component.remove();
                            placedComponents = placedComponents.filter(c => c !== component);
                            updateWireConnections(); // Actualizar cables restantes
                            soundPowerOff.play();
                        }
                    });
                    
                    circuitBoard.appendChild(component);
                    placedComponents.push(component);
                    
                    return component;
                }
                
                // Añadir puntos de conexión a un componente
                function addConnectionPoints(component) {
                    const type = component.dataset.type;
                    const rect = component.getBoundingClientRect();
                    const width = rect.width;
                    const height = rect.height;
                    
                    // Limpiar puntos de conexión existentes
                    const existingPoints = component.querySelectorAll('.connection-point');
                    existingPoints.forEach(point => point.remove());
                    
                    // Añadir puntos según el tipo de componente
                    if (type === 'battery' || type === 'resistor' || type === 'wire') {
                        // Dos puntos de conexión (izquierda y derecha)
                        const leftPoint = document.createElement('div');
                        leftPoint.className = 'connection-point';
                        leftPoint.style.left = '0px';
                        leftPoint.style.top = `${height/2 - 6}px`;
                        component.appendChild(leftPoint);
                        
                        const rightPoint = document.createElement('div');
                        rightPoint.className = 'connection-point';
                        rightPoint.style.right = '0px';
                        rightPoint.style.top = `${height/2 - 6}px`;
                        component.appendChild(rightPoint);
                        
                        // Hacer los puntos conectables
                        makeConnectable(leftPoint, component);
                        makeConnectable(rightPoint, component);
                    } else if (type === 'bulb') {
                        // Dos puntos de conexión (abajo)
                        const leftPoint = document.createElement('div');
                        leftPoint.className = 'connection-point';
                        leftPoint.style.left = `${width/3 - 6}px`;
                        leftPoint.style.bottom = '0px';
                        component.appendChild(leftPoint);
                        
                        const rightPoint = document.createElement('div');
                        rightPoint.className = 'connection-point';
                        rightPoint.style.right = `${width/3 - 6}px`;
                        rightPoint.style.bottom = '0px';
                        component.appendChild(rightPoint);
                        
                        makeConnectable(leftPoint, component);
                        makeConnectable(rightPoint, component);
                    } else if (type === 'switch') {
                        // Dos puntos de conexión (entrada y salida)
                        const inPoint = document.createElement('div');
                        inPoint.className = 'connection-point';
                        inPoint.style.left = '0px';
                        inPoint.style.top = `${height/2 - 6}px`;
                        component.appendChild(inPoint);
                        
                        const outPoint = document.createElement('div');
                        outPoint.className = 'connection-point';
                        outPoint.style.right = '0px';
                        outPoint.style.top = `${height/2 - 6}px`;
                        component.appendChild(outPoint);
                        
                        makeConnectable(inPoint, component);
                        makeConnectable(outPoint, component);
                        
                        // Hacer el interruptor clickeable
                        component.addEventListener('click', function(e) {
                            if (e.target.classList.contains('connection-point')) return;
                            
                            const icon = this.querySelector('i');
                            if (this.dataset.state === 'off') {
                                this.dataset.state = 'on';
                                icon.classList.remove('fa-toggle-off');
                                icon.classList.add('fa-toggle-on');
                                soundPowerOn.play();
                            } else {
                                this.dataset.state = 'off';
                                icon.classList.remove('fa-toggle-on');
                                icon.classList.add('fa-toggle-off');
                                soundPowerOff.play();
                            }
                        });
                    } else if (type === 'led') {
                        // Dos puntos de conexión abajo (como el foco)
                        const leftPoint = document.createElement('div');
                        leftPoint.className = 'connection-point anode';
                        leftPoint.style.left = `${width/3 - 6}px`;
                        leftPoint.style.bottom = '0px';
                        leftPoint.title = 'Ánodo (positivo)';
                        component.appendChild(leftPoint);
                        
                        const rightPoint = document.createElement('div');
                        rightPoint.className = 'connection-point cathode';
                        rightPoint.style.right = `${width/3 - 6}px`;
                        rightPoint.style.bottom = '0px';
                        rightPoint.title = 'Cátodo (negativo)';
                        component.appendChild(rightPoint);
                        
                        makeConnectable(leftPoint, component);
                        makeConnectable(rightPoint, component);
                        
                        // Marcar polaridad en el LED
                        component.dataset.polarity = 'correct';
                    }
                }
                
                // Hacer un componente arrastrable
                function makeDraggable(element) {
                    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                    
                    // Eventos para desktop
                    element.addEventListener('mousedown', dragMouseDown);
                    
                    function dragMouseDown(e) {
                        e.preventDefault();
                        
                        // Solo arrastrar si no estamos conectando
                        if (isConnecting) return;
                        
                        // Obtener la posición inicial del ratón
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        
                        document.onmouseup = closeDragElement;
                        document.onmousemove = elementDrag;
                    }
                    
                    function elementDrag(e) {
                        e.preventDefault();
                        
                        // Calcular la nueva posición
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        
                        // Establecer la nueva posición del elemento
                        element.style.top = (element.offsetTop - pos2) + "px";
                        element.style.left = (element.offsetLeft - pos1) + "px";
                        
                        // Actualizar las conexiones de cables
                        updateWireConnections();
                    }
                    
                    function closeDragElement() {
                        // Detener el movimiento
                        document.onmouseup = null;
                        document.onmousemove = null;
                    }
                }
                
                // Función mejorada para conexiones
                function makeConnectable(point, parentComponent) {
                    point.addEventListener('mousedown', startConnection);
                    
                    function startConnection(e) {
                        e.stopPropagation();
                        isConnecting = true;
                        
                        // Crear un cable temporal
                        const tempWire = document.createElement('div');
                        tempWire.className = 'wire-connection';
                        tempWire.id = 'temp-wire';
                        
                        // Guardar la posición inicial
                        const startRect = point.getBoundingClientRect();
                        const boardRect = circuitBoard.getBoundingClientRect();
                        const startX = startRect.left + startRect.width/2 - boardRect.left;
                        const startY = startRect.top + startRect.height/2 - boardRect.top;
                        
                        tempWire.style.left = `${startX}px`;
                        tempWire.style.top = `${startY}px`;
                        circuitBoard.appendChild(tempWire);
                        
                        // Función para mover el cable
                        function moveWire(clientX, clientY) {
                            const endX = clientX - boardRect.left;
                            const endY = clientY - boardRect.top;
                            
                            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                            const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                            
                            tempWire.style.width = `${length}px`;
                            tempWire.style.transform = `rotate(${angle}deg)`;
                        }
                        
                        document.onmousemove = function(e) {
                            moveWire(e.clientX, e.clientY);
                        };
                        
                        // Función para finalizar la conexión
                        function endConnection(clientX, clientY) {
                            // Eliminar eventos
                            document.onmousemove = null;
                            document.onmouseup = null;
                            
                            // Eliminar el cable temporal
                            tempWire.remove();
                            
                            // Verificar si se soltó sobre otro punto de conexión
                            const endElements = document.elementsFromPoint(clientX, clientY);
                            const endPoint = endElements.find(el => 
                                el.classList.contains('connection-point') && 
                                el !== point &&
                                el.parentElement !== parentComponent
                            );
                            
                            if (endPoint) {
                                // Verificar polaridad para LED (solo en nivel 4)
                                if (currentLevel === 4) {
                                    const startParent = point.parentElement;
                                    const endParent = endPoint.parentElement;
                                    
                                    // Verificar si estamos conectando un LED
                                    if (startParent.dataset.type === 'led' || endParent.dataset.type === 'led') {
                                        const led = startParent.dataset.type === 'led' ? startParent : endParent;
                                        const otherComponent = startParent.dataset.type === 'led' ? endParent : startParent;
                                        const ledPoint = startParent.dataset.type === 'led' ? point : endPoint;
                                        const otherPoint = startParent.dataset.type === 'led' ? endPoint : point;
                                        
                                        // Verificar polaridad
                                        if (otherComponent.dataset.type === 'battery') {
                                            if ((ledPoint.classList.contains('anode') && otherPoint.style.left === '0px') || 
                                                (ledPoint.classList.contains('cathode') && otherPoint.style.right === '0px')) {
                                                // Polaridad incorrecta
                                                led.dataset.polarity = 'incorrect';
                                                showFeedback("¡Polaridad incorrecta en el LED! El ánodo debe conectarse al positivo de la batería.", "error");
                                            } else {
                                                // Polaridad correcta
                                                led.dataset.polarity = 'correct';
                                            }
                                        }
                                    }
                                }
                                
                                // Crear conexión permanente
                                createConnection(point, endPoint);
                                soundPowerOn.play();
                            }
                            
                            isConnecting = false;
                        }
                        
                        document.onmouseup = function(e) {
                            endConnection(e.clientX, e.clientY);
                        };
                    }
                }
                
                // Crear una conexión entre dos puntos
                function createConnection(startPoint, endPoint) {
                    // Verificar si ya existe esta conexión
                    const connectionExists = connections.some(conn => 
                        (conn.start === startPoint && conn.end === endPoint) || 
                        (conn.start === endPoint && conn.end === startPoint)
                    );
                    
                    if (connectionExists) return;
                    
                    // Crear la línea de conexión
                    const wire = document.createElement('div');
                    wire.className = 'wire-connection';
                    
                    // Calcular posición y ángulo
                    const startRect = startPoint.getBoundingClientRect();
                    const endRect = endPoint.getBoundingClientRect();
                    const boardRect = circuitBoard.getBoundingClientRect();
                    
                    const startX = startRect.left + startRect.width/2 - boardRect.left;
                    const startY = startRect.top + startRect.height/2 - boardRect.top;
                    const endX = endRect.left + endRect.width/2 - boardRect.left;
                    const endY = endRect.top + endRect.height/2 - boardRect.top;
                    
                    const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                    
                    wire.style.width = `${length}px`;
                    wire.style.left = `${startX}px`;
                    wire.style.top = `${startY}px`;
                    wire.style.transform = `rotate(${angle}deg)`;
                    
                    // Hacer el cable clickeable para eliminarlo
                    wire.addEventListener('click', function(e) {
                        if (e.ctrlKey || e.metaKey) { // Ctrl+Click o Cmd+Click para eliminar
                            const index = connections.findIndex(conn => conn.element === wire);
                            if (index !== -1) {
                                connections.splice(index, 1);
                                wire.remove();
                                soundPowerOff.play();
                                
                                // Verificar si estamos desconectando un LED para resetear su polaridad
                                const startParent = connections[index].start.parentElement;
                                const endParent = connections[index].end.parentElement;
                                
                                if (startParent.dataset.type === 'led' || endParent.dataset.type === 'led') {
                                    const led = startParent.dataset.type === 'led' ? startParent : endParent;
                                    led.dataset.polarity = 'correct';
                                }
                            }
                        }
                    });
                    
                    circuitBoard.appendChild(wire);
                    
                    // Guardar la conexión
                    connections.push({
                        start: startPoint,
                        end: endPoint,
                        element: wire
                    });
                }
                
                // Actualizar las conexiones de cables cuando se mueve un componente
                function updateWireConnections() {
                    connections.forEach(connection => {
                        const startRect = connection.start.getBoundingClientRect();
                        const endRect = connection.end.getBoundingClientRect();
                        const boardRect = circuitBoard.getBoundingClientRect();
                        
                        const startX = startRect.left + startRect.width/2 - boardRect.left;
                        const startY = startRect.top + startRect.height/2 - boardRect.top;
                        
                        const endX = endRect.left + endRect.width/2 - boardRect.left;
                        const endY = endRect.top + endRect.height/2 - boardRect.top;
                        
                        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                        const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                        
                        connection.element.style.width = `${length}px`;
                        connection.element.style.left = `${startX}px`;
                        connection.element.style.top = `${startY}px`;
                        connection.element.style.transform = `rotate(${angle}deg)`;
                    });
                }
                
                // Verificar el circuito
                function checkCircuit() {
                    attempts++;
                    attemptsDisplay.textContent = attempts;
                    
                    const levelData = levels[currentLevel];
                    let isValid = true;
                    let message = "";
                    
                    // Verificar componentes requeridos
                    const componentTypes = placedComponents.map(c => c.dataset.type);
                    const missingComponents = levelData.requiredComponents.filter(type => {
                        const requiredCount = levelData.requiredComponents.filter(t => t === type).length;
                        const actualCount = componentTypes.filter(t => t === type).length;
                        return actualCount < requiredCount;
                    });
                    
                    if (missingComponents.length > 0) {
                        isValid = false;
                        message = `Faltan componentes: ${[...new Set(missingComponents)].join(', ')}`;
                    }
                    
                    // Verificar conexiones mínimas
                    if (connections.length < levelData.requiredConnections) {
                        isValid = false;
                        message = `Necesitas al menos ${levelData.requiredConnections} conexiones para completar el circuito.`;
                    }
                    
                    // Verificar si el circuito está cerrado (simplificado)
                    if (isValid) {
                        // Calcular valores del circuito
                        let totalVoltage = 0;
                        let totalResistance = 0;
                        
                        placedComponents.forEach(component => {
                            if (component.dataset.type === 'battery') {
                                totalVoltage += parseFloat(component.dataset.voltage);
                            } else if (component.dataset.resistance) {
                                totalResistance += parseFloat(component.dataset.resistance);
                            }
                        });
                        
                        // Cálculo especial para circuito en paralelo (nivel 3)
                        if (currentLevel === 3 && typeof levelData.resistance === 'object' && levelData.resistance.type === "parallel") {
                            const bulbs = placedComponents.filter(c => c.dataset.type === 'bulb');
                            if (bulbs.length >= 2) {
                                // Calcular resistencia en paralelo: 1/Rt = 1/R1 + 1/R2 + ...
                                const inverseResistance = bulbs.reduce((sum, bulb) => {
                                    return sum + (1 / parseFloat(bulb.dataset.resistance));
                                }, 0);
                                totalResistance = 1 / inverseResistance;
                            }
                        }
                        
                        const current = totalVoltage / (totalResistance || 1); // Evitar división por cero
                        
                        // Verificación especial para el nivel 4 (LED)
                        if (currentLevel === 4) {
                            const led = placedComponents.find(c => c.dataset.type === 'led');
                            const resistor = placedComponents.find(c => c.dataset.type === 'resistor');
                            
                            // Verificar polaridad del LED
                            if (led && led.dataset.polarity === 'incorrect') {
                                isValid = false;
                                message = "¡Polaridad incorrecta en el LED! El ánodo debe conectarse al positivo de la batería.";
                            }
                            // Verificar resistencia adecuada para el LED
                            else if (resistor) {
                                const resistorValue = parseFloat(resistor.dataset.resistance);
                                if (resistorValue < levelData.resistance.min || resistorValue > levelData.resistance.max) {
                                    isValid = false;
                                    message = `La resistencia (${resistorValue}Ω) no está en el rango adecuado (${levelData.resistance.min}-${levelData.resistance.max}Ω) para proteger el LED.`;
                                }
                            }
                        }
                        // Verificar valores esperados para otros niveles
                        else if (currentLevel === 3 && typeof levelData.resistance === 'object' && levelData.resistance.type === "parallel") {
                            // Verificación para circuito en paralelo (nivel 3)
                            const expectedResistance = levelData.resistance.expected;
                            if (Math.abs(totalResistance - expectedResistance) > 5) {
                                isValid = false;
                                message = `La resistencia total del circuito (${totalResistance.toFixed(2)}Ω) no es la esperada para un circuito en paralelo (${expectedResistance}Ω).`;
                            }
                        } 
                        else if (currentLevel !== 4 && typeof levelData.resistance === 'number' && Math.abs(totalResistance - levelData.resistance) > 5) {
                            isValid = false;
                            message = `La resistencia del circuito (${totalResistance}Ω) no es la adecuada (${levelData.resistance}Ω).`;
                        }
                        
                        // Verificar voltaje
                        if (Math.abs(totalVoltage - levelData.voltage) > 0.1) {
                            isValid = false;
                            message = `El voltaje del circuito (${totalVoltage}V) no coincide con el requerido (${levelData.voltage}V).`;
                        }
                        
                        // Si todo está bien hasta ahora, encender los componentes
                        if (isValid) {
                            // Verificar interruptores
                            const switches = placedComponents.filter(c => c.dataset.type === 'switch');
                            const switchedOff = switches.some(sw => sw.dataset.state === 'off');
                            
                            if (switchedOff) {
                                isValid = false;
                                message = "¡El interruptor está apagado! Enciéndelo para completar el circuito.";
                                
                                // Apagar los componentes si el interruptor está apagado
                                placedComponents.forEach(component => {
                                    if (component.dataset.type === 'bulb' || component.dataset.type === 'led') {
                                        component.classList.remove('on');
                                        const icon = component.querySelector('i');
                                        icon.style.textShadow = 'none';
                                        icon.style.color = '';
                                    }
                                });
                            } else {
                                // Encender los componentes que correspondan
                                placedComponents.forEach(component => {
                                    if (component.dataset.type === 'bulb' || component.dataset.type === 'led') {
                                        component.classList.add('on');
                                        const icon = component.querySelector('i');
                                        
                                        if (component.dataset.type === 'bulb') {
                                            icon.style.color = '#ffeb3b';
                                            icon.style.textShadow = '0 0 10px #ffeb3b, 0 0 20px #ffeb3b, 0 0 30px #ffeb3b';
                                        } else {
                                            icon.style.color = '#00ff00';
                                            icon.style.textShadow = '0 0 5px #00ff00, 0 0 10px #00ff00';
                                        }
                                    }
                                });
                                
                                // Circuito completado correctamente
                                score += levelData.points;
                                scoreDisplay.textContent = score;
                                message = `¡Circuito completado correctamente! +${levelData.points} puntos`;
                                
                                // Pasar al siguiente nivel después de 2 segundos
                                setTimeout(() => {
                                    if (currentLevel < Object.keys(levels).length) {
                                        soundLevelUp.play();
                                        changeLevel(currentLevel + 1);
                                    } else {
                                        showFeedback(`¡Felicidades! Has completado todos los niveles con ${score} puntos`, "success");
                                    }
                                }, 2000);
                            }
                        }
                    }
                    
                    if (isValid) {
                        showFeedback(message, "success");
                        updateEnergy(10); // Recompensa por completar el nivel
                    } else {
                        showFeedback(message, "error");
                        updateEnergy(-15); // Penalización por error
                    }
                }
                
                // Event listeners para los componentes arrastrables
                document.querySelectorAll('.component').forEach(component => {
                    component.addEventListener('dragstart', function(e) {
                        draggedComponent = this;
                        e.dataTransfer.setData('text/plain', this.dataset.type);
                        setTimeout(() => {
                            this.style.display = 'none';
                        }, 0);
                    });
                    
                    component.addEventListener('dragend', function() {
                        this.style.display = 'flex';
                        draggedComponent = null;
                    });
                });
                
                // Event listener para soltar componentes en el área de trabajo
                circuitBoard.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                circuitBoard.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (!draggedComponent) return;
                    
                    const type = draggedComponent.dataset.type;
                    const rect = circuitBoard.getBoundingClientRect();
                    const x = e.clientX - rect.left - 40;
                    const y = e.clientY - rect.top - 40;
                    
                    // Crear una copia del componente en el área de trabajo
                    createPlacedComponent(
                        type, 
                        x, 
                        y, 
                        {
                            voltage: draggedComponent.dataset.voltage || 0,
                            resistance: draggedComponent.dataset.resistance || 0
                        }
                    );
                });
                
                // Event listeners para los botones de control
                checkButton.addEventListener('click', checkCircuit);
                resetButton.addEventListener('click', resetCircuit);
                clearAllButton.addEventListener('click', resetCircuit);
                
                // Cargar el primer nivel al iniciar
                changeLevel(1);
            });
        }
    </script>
</body>
</html>